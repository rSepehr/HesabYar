# file: dialogs/help_dialog.py
from PySide6.QtWidgets import (
    QDialog,
    QHBoxLayout,
    QListWidget,
    QTextEdit,
    QSplitter,
    QListWidgetItem,
)
from PySide6.QtCore import Qt


class HelpDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("راهنمای کامل برنامه حساب‌یار")
        self.setMinimumSize(800, 600)

        self.help_topics = {
            "مقدمه و شروع به کار": """
                <h2>به حساب‌یار خوش آمدید!</h2>
                <p>این برنامه یک ابزار جامع برای مدیریت امور مالی کسب‌وکار شماست. با استفاده از «حساب‌یار» می‌توانید فروش، خرید، هزینه‌ها، موجودی انبار و وضعیت چک‌های خود را به سادگی مدیریت کرده و گزارش‌های تحلیلی دقیقی از عملکرد مالی خود داشته باشید.</p>
                <p>برای شروع، پیشنهاد می‌شود ابتدا از بخش <b>تنظیمات</b>، اطلاعات اولیه کسب‌وکار و حساب‌های مالی خود را تعریف کنید.</p>
                <p>«حساب‌یار» با عشق و دقت توسط یک توسعه‌دهنده‌ی ایرانی طراحی شده که هدفش ارائه‌ی یک نرم‌افزار حسابداری قدرتمند، رایگان و قابل‌اتکا برای تمام کسب‌وکارهاست. اگر دوست دارید به پیشرفت پروژه کمک کنید یا کدها را بررسی کنید، از طریق لینک زیر به گیت‌هاب من سر بزنید:</p>
                <p>ارادتمند شما٬ سپهر عبقری.</p>
                <p><a href="لینک_گیتهاب_اینجا_قرار_می‌گیرد" target="_blank">مشاهده پروژه در GitHub</a></p>
                """,
            "داشبورد": """
                <h3>راهنمای داشبورد</h3>
                <p>داشبورد، نمای کلی و زنده از وضعیت کسب‌وکار شما را نمایش می‌دهد. در این بخش می‌توانید:</p>
                <ul>
                    <li><b>شاخص‌های کلیدی مالی:</b> فروش، هزینه و سود خالص برای ماه جاری را مشاهده کنید.</li>
                    <li><b>هشدار موجودی کالا:</b> کالاهایی که موجودی انبار آن‌ها از حد معینی (پیش‌فرض: ۱۰ عدد) کمتر شده را شناسایی کنید.</li>
                    <li><b>چک‌های در انتظار وصول:</b> لیست چک‌های دریافتی که تاریخ سررسید آن‌ها نزدیک است را برای پیگیری مشاهده کنید.</li>
                    <li><b>دسترسی سریع:</b> از این بخش می‌توانید به سرعت یک فاکتور فروش، مشتری یا هزینه جدید ثبت کنید.</li>
                </ul>
                """,
            "مشتریان": """
                <h3>راهنمای بخش مشتریان</h3>
                <p>در این بخش می‌توانید لیست تمام مشتریان خود را مدیریت کنید.</p>
                <p><b>پیش‌نیاز:</b> برای صدور فاکتور فروش، ابتدا باید مشتری مورد نظر در این بخش ثبت شده باشد. اطلاعاتی مانند کد ملی و کد اقتصادی در فاکتورهای رسمی استفاده می‌شوند.</p>
                """,
            "تامین‌کنندگان": """
                <h3>راهنمای بخش تامین‌کنندگان</h3>
                <p>این بخش برای مدیریت لیست شرکت‌ها یا افرادی است که شما از آن‌ها کالا یا خدمات خریداری می‌کنید.</p>
                <p><b>پیش‌نیاز:</b> برای ثبت فاکتور خرید، ابتدا باید تامین‌کننده در این بخش ثبت شده باشد.</p>
                """,
            "فاکتورهای فروش": """
                <h3>راهنمای فاکتورهای فروش</h3>
                <p>از این بخش برای ثبت فروش محصولات یا خدمات به مشتریان استفاده کنید.</p>
                <p><b>روش کار و تاثیرات:</b></p>
                <ol>
                    <li>یک مشتری و اقلام فاکتور (کالاها) را انتخاب می‌کنید.</li>
                    <li>وضعیت پرداخت (پرداخت شده، کسری، پرداخت نشده) و روش پرداخت (نقدی، چکی) را مشخص می‌کنید.</li>
                    <li>پس از ذخیره، موجودی کالاهای مربوطه به صورت خودکار از انبار <b>کسر</b> می‌شود.</li>
                    <li>بهای تمام شده آن کالاها برای گزارش سود و زیان ثبت می‌گردد.</li>
                    <li>اگر پرداخت چکی باشد، یک چک جدید به صورت خودکار در بخش «چک‌ها» ثبت می‌شود.</li>
                </ol>
                """,
            "فاکتورهای خرید": """
                <h3>راهنمای فاکتورهای خرید</h3>
                <p>برای ثبت خریدهای خود از تامین‌کنندگان، از این بخش استفاده کنید.</p>
                <p><b>روش کار و تاثیرات:</b></p>
                <ol>
                    <li>یک تامین‌کننده و کالاهای خریداری شده به همراه قیمت خرید آن‌ها را وارد می‌کنید.</li>
                    <li>پس از ذخیره، موجودی کالاهای خریداری شده به صورت خودکار در انبار <b>افزایش</b> می‌یابد.</li>
                    <li>سیستم به صورت هوشمند، میانگین قیمت خرید آن کالاها را برای استفاده در گزارش‌های آینده، محاسبه و به‌روز می‌کند.</li>
                </ol>
                """,
            "کالاها و خدمات": """
                <h3>راهنمای کالاها و خدمات</h3>
                <p>در این بخش، لیست تمام محصولات یا خدماتی که ارائه می‌دهید را تعریف و مدیریت می‌کنید.</p>
                <p><b>پیش‌نیاز مهم:</b> هنگام افزودن یک کالای جدید، حتماً موارد زیر را با دقت وارد کنید:</p>
                <ul>
                    <li><b>حساب درآمد مربوطه:</b> مشخص می‌کند که درآمد حاصل از فروش این کالا، در گزارش‌ها زیر کدام دسته قرار بگیرد. (مثلاً: حساب «فروش کالای دیجیتال»).</li>
                    <li><b>موجودی اولیه/فعلی:</b> تعداد موجودی فعلی آن کالا در انبار شما.</li>
                </ul>
                """,
            "هزینه‌ها": """
                <h3>راهنمای بخش هزینه‌ها</h3>
                <p>این بخش برای ثبت تمام هزینه‌های جاری کسب‌وکار شماست که جزو خرید کالا برای فروش مجدد نیستند (مانند اجاره، حقوق، اینترنت، تبلیغات و...).</p>
                <p><b>پیش‌نیاز:</b> هنگام ثبت هزینه، آن را به «حساب هزینه مربوطه» (که در تنظیمات تعریف کرده‌اید) متصل کنید تا گزارش سود و زیان شما دقیق باشد.</p>
                """,
            "چک‌ها": """
                <h3>راهنمای بخش چک‌ها</h3>
                <p>برای مدیریت چک‌های دریافتی از مشتریان. می‌توانید وضعیت چک‌ها را به «پاس شده» یا «برگشتی» تغییر دهید. چک‌هایی که تاریخ سررسیدشان نزدیک است برای یادآوری رنگی می‌شوند.</p>
                """,
            "گزارش‌ها": """
                <h3>راهنمای بخش گزارش‌ها</h3>
                <p>این بخش مرکز تحلیل مالی شماست. مهم‌ترین گزارش، <b>«سود و زیان»</b> است که با انتخاب بازه زمانی، به شما یک گزارش تحلیلی دقیق از عملکرد مالی‌تان ارائه می‌دهد. این گزارش به تفکیک حساب‌های درآمد و هزینه است و بهای تمام شده کالاها را نیز در محاسبات لحاظ می‌کند تا سود واقعی شما مشخص شود.</p>
                """,
            "تنظیمات": """
                <h3>راهنمای بخش تنظیمات</h3>
                <p>این بخش شامل تنظیمات کلی برنامه است:</p>
                <ul>
                    <li><b>مشخصات شرکت:</b> اطلاعاتی که در سربرگ فاکتورها چاپ می‌شود.</li>
                    <li><b>مدیریت حساب‌ها:</b> برای تعریف سرفصل‌های درآمد و هزینه (بسیار مهم).</li>
                    <li><b>تنظیمات مالی:</b> برای تعریف قالب‌های هزینه مثل مالیات یا هزینه حمل.</li>
                    <li><b>ظاهر برنامه:</b> برای تغییر تم برنامه به روشن یا تاریک.</li>
                    <li><b>پشتیبان‌گیری و خروجی:</b> برای گرفتن نسخه پشتیبان کامل از دیتابیس یا خروجی CSV از داده‌ها.</li>
                </ul>
                """,
            "پشتیبان‌گیری و بازیابی": """
                <h3>راهنمای پشتیبان‌گیری و بازیابی</h3>
                <p>در بخش <b>تنظیمات -> پشتیبان‌گیری و خروجی</b>، دو قابلیت مهم وجود دارد:</p>
                <p><b>۱. تهیه/بازیابی نسخه پشتیبان:</b> این گزینه یک کپی کامل از کل دیتابیس شما (فایل accounting.db) تهیه می‌کند. این بهترین راه برای حفظ امنیت اطلاعات شماست. همیشه به صورت منظم نسخه پشتیبان تهیه کنید.</p>
                <p><b>۲. خروجی CSV:</b> این گزینه به شما اجازه می‌دهد تا داده‌های یک بخش خاص (مثلاً لیست مشتریان یا فاکتورها) را در قالب فایل CSV ذخیره کنید. این فایل‌ها در نرم‌افzارهایی مثل اکسل قابل استفاده هستند.</p>
                <p><b>تفاوت کلیدی:</b> پشتیبان‌گیری کل اطلاعات را برای بازیابی احتمالی ذخیره می‌کند، اما خروجی CSV برای تحلیل داده‌ها در نرم‌افزارهای دیگر کاربرد دارد.</p>
                """,
            "پروفایل کاربری": """
                <h3>راهنمای پروفایل کاربری</h3>
                <p>در این بخش می‌توانید اطلاعات حساب کاربری خود که با آن وارد برنامه شده‌اید را مدیریت کنید. می‌توانید رمز عبور خود را تغییر دهید و یا سوال و جواب امنیتی خود را برای مواقعی که رمزتان را فراموش کرده‌اید، تنظیم یا ویرایش کنید.</p>
                """,
        }

        main_layout = QHBoxLayout(self)

        self.list_widget = QListWidget(self)
        self.text_edit = QTextEdit(self)
        self.text_edit.setReadOnly(True)
        self.text_edit.setLayoutDirection(Qt.LayoutDirection.RightToLeft)

        splitter = QSplitter(Qt.Orientation.Horizontal)
        splitter.addWidget(self.text_edit)
        splitter.addWidget(self.list_widget)
        splitter.setSizes([600, 200])

        main_layout.addWidget(splitter)

        self.populate_list()
        self.list_widget.currentItemChanged.connect(self.display_topic)

        if self.list_widget.count() > 0:
            self.list_widget.setCurrentRow(0)

    def populate_list(self):
        """لیست موضوعات را پر می‌کند."""
        for topic in self.help_topics.keys():
            item = QListWidgetItem(topic)
            item.setTextAlignment(Qt.AlignmentFlag.AlignRight)
            self.list_widget.addItem(item)

    def display_topic(self, current_item, previous_item):
        """متن مربوط به موضوع انتخاب شده را نمایش می‌دهد."""
        if current_item:
            topic_title = current_item.text()
            self.text_edit.setHtml(
                self.help_topics.get(topic_title, "<p>موضوعی یافت نشد.</p>")
            )
